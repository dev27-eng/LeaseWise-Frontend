{% extends "base.html" %}

{% block title %}Checkout - LeaseCheck{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/checkout.css') }}">
{% endblock %}

{% block content %}
<div class="checkout-screen">
    <!-- Green header -->
    <header class="green-header">
        <h1>Checkout</h1>
    </header>

    <main class="checkout-content">
        <!-- Test mode notice -->
        <div class="test-mode-notice">
            <h4>ðŸ”” Test Mode</h4>
            <ul>
                <li><strong>Card Number:</strong> 4242 4242 4242 4242</li>
                <li><strong>Expiry:</strong> Any future date</li>
                <li><strong>CVC:</strong> Any 3 digits</li>
                <li><strong>ZIP:</strong> Any 5 digits</li>
            </ul>
        </div>

        <!-- Order summary -->
        <div class="order-summary">
            <h2>Order Summary</h2>
            <div class="plan-details">
                <h3>{{ plan_name }}</h3>
                <div class="plan-price">${{ "%.2f"|format(plan_price) }}</div>
                <ul class="plan-features">
                    {% for feature in PLANS[plan_id]['features'] %}
                        <li>{{ feature }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Payment form -->
        <form id="payment-form" class="payment-form">
            <!-- Contact Information -->
            <div class="form-section">
                <h3>Contact Information</h3>
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" required>
                    <div id="fullName-error" class="error-message"></div>
                </div>
                <div class="form-row">
                    <div class="form-group half">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" required>
                        <div id="email-error" class="error-message"></div>
                    </div>
                    <div class="form-group half">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" required>
                        <div id="phone-error" class="error-message"></div>
                    </div>
                </div>
            </div>

            <!-- Billing Address -->
            <div class="form-section">
                <h3>Billing Address</h3>
                <div class="form-group">
                    <label for="street">Street Address</label>
                    <input type="text" id="street" required>
                    <div id="street-error" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="street2">Apartment, suite, etc. (optional)</label>
                    <input type="text" id="street2">
                </div>
                <div class="form-row">
                    <div class="form-group half">
                        <label for="city">City</label>
                        <input type="text" id="city" required>
                        <div id="city-error" class="error-message"></div>
                    </div>
                    <div class="form-group half">
                        <label for="state">State/Province</label>
                        <input type="text" id="state" required>
                        <div id="state-error" class="error-message"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group half">
                        <label for="zipCode">ZIP/Postal Code</label>
                        <input type="text" id="zipCode" required>
                        <div id="zipCode-error" class="error-message"></div>
                    </div>
                    <div class="form-group half">
                        <label for="country">Country</label>
                        <select id="country" required>
                            <option value="">Select a country</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="GB">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="NZ">New Zealand</option>
                        </select>
                        <div id="country-error" class="error-message"></div>
                    </div>
                </div>
            </div>

            <!-- Payment Information -->
            <div class="form-section">
                <h3>Payment Information</h3>
                <div id="card-element"></div>
                <div id="card-errors" role="alert"></div>
            </div>

            <button type="submit" class="pay-button">Pay ${{"%.2f"|format(plan_price)}}</button>
        </form>
    </main>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    // Initialize Stripe and elements (keep as const)
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();

    // Card element styling
    const cardElementOptions = {
        style: {
            base: {
                fontSize: '16px',
                color: '#32325d',
                fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                fontSmoothing: 'antialiased',
                '::placeholder': {
                    color: '#aab7c4'
                },
                ':-webkit-autofill': {
                    color: '#32325d'
                }
            },
            invalid: {
                color: '#fa755a',
                iconColor: '#fa755a',
                '::placeholder': {
                    color: '#FFCCA5'
                }
            }
        }
    };

    // Create card element (use let since it needs to be reassigned)
    let cardElement = null;
    try {
        cardElement = elements.create('card', cardElementOptions);
        cardElement.mount('#card-element');
    } catch (error) {
        console.error('Error creating card element:', error);
        document.getElementById('card-errors').textContent = 'Error initializing payment form. Please refresh the page.';
    }

    // Validation functions
    const validateEmail = (email) => {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    const validatePhone = (phone) => {
        return /^\+?[\d\s-()]{10,}$/.test(phone);
    }

    const validateRequired = (value, fieldName) => {
        if (!value || value.trim() === '') {
            return `${fieldName} is required`;
        }
        return '';
    }

    const validateForm = () => {
        let isValid = true;
        const fields = {
            'fullName': 'Full Name',
            'email': 'Email Address',
            'phone': 'Phone Number',
            'street': 'Street Address',
            'city': 'City',
            'state': 'State/Province',
            'zipCode': 'ZIP/Postal Code',
            'country': 'Country'
        };

        for (const id in fields) {
            const element = document.getElementById(id);
            const errorElement = document.getElementById(`${id}-error`);
            const error = validateRequired(element.value, fields[id]);
            
            if (error) {
                errorElement.textContent = error;
                errorElement.style.display = 'block';
                isValid = false;
            } else {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }

        const emailElement = document.getElementById('email');
        const emailErrorElement = document.getElementById('email-error');
        if (!validateEmail(emailElement.value)) {
            emailErrorElement.textContent = 'Please enter a valid email address';
            emailErrorElement.style.display = 'block';
            isValid = false;
        }

        const phoneElement = document.getElementById('phone');
        const phoneErrorElement = document.getElementById('phone-error');
        if (!validatePhone(phoneElement.value)) {
            phoneErrorElement.textContent = 'Please enter a valid phone number';
            phoneErrorElement.style.display = 'block';
            isValid = false;
        }

        return isValid;
    }

    // Handle card element errors
    if (cardElement) {
        cardElement.addEventListener('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
    }

    // Form submission handler
    document.getElementById('payment-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        if (!validateForm() || !cardElement) {
            return;
        }

        const submitButton = document.querySelector('.pay-button');
        submitButton.disabled = true;
        
        try {
            const { paymentMethod, error: paymentMethodError } = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement,
                billing_details: {
                    name: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: {
                        line1: document.getElementById('street').value,
                        line2: document.getElementById('street2').value || '',
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        postal_code: document.getElementById('zipCode').value,
                        country: document.getElementById('country').value
                    }
                }
            });

            if (paymentMethodError) {
                const errorElement = document.getElementById('card-errors');
                switch(paymentMethodError.code) {
                    case 'incomplete_cvc':
                    case 'invalid_cvc':
                        errorElement.textContent = 'Please enter a valid CVC/CVV number.';
                        break;
                    case 'card_declined':
                        errorElement.textContent = 'Your card was declined. Please try a different card.';
                        break;
                    case 'expired_card':
                        errorElement.textContent = 'Your card has expired. Please try a different card.';
                        break;
                    default:
                        errorElement.textContent = paymentMethodError.message;
                }
                submitButton.disabled = false;
                return;
            }

            const formData = {
                payment_method_id: paymentMethod.id,
                plan_id: '{{ plan_id }}',
                user_info: {
                    full_name: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: {
                        street: document.getElementById('street').value,
                        street2: document.getElementById('street2').value || '',
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        zip_code: document.getElementById('zipCode').value,
                        country: document.getElementById('country').value
                    }
                }
            };

            const response = await fetch('/create-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.requires_action) {
                const { error: confirmError } = await stripe.confirmCardPayment(data.client_secret);
                if (confirmError) {
                    const errorElement = document.getElementById('card-errors');
                    switch(confirmError.code) {
                        case 'incomplete_cvc':
                        case 'invalid_cvc':
                            errorElement.textContent = 'Please enter a valid CVC/CVV number.';
                            break;
                        case 'authentication_required':
                            errorElement.textContent = 'Your card requires authentication. Please complete the verification process.';
                            break;
                        default:
                            errorElement.textContent = confirmError.message;
                    }
                    submitButton.disabled = false;
                } else {
                    window.location.href = '/payment-status?status=success';
                }
            } else if (data.success) {
                window.location.href = '/payment-status?status=success';
            } else if (data.error) {
                const errorElement = document.getElementById('card-errors');
                errorElement.textContent = data.error;
                submitButton.disabled = false;
            } else {
                window.location.href = '/payment-status?status=failed';
            }
        } catch (error) {
            console.error('Payment processing error:', error);
            const errorElement = document.getElementById('card-errors');
            errorElement.textContent = 'An error occurred processing your payment. Please try again.';
            submitButton.disabled = false;
        }
    });
</script>
{% endblock %}
