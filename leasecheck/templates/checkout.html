{% extends "base.html" %}

{% block title %}Checkout - LeaseCheck{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/checkout.css') }}">
{% endblock %}

{% block content %}
<div class="checkout-screen">
    <header class="green-header">
        <h1>Checkout</h1>
    </header>

    <main class="checkout-content">
        <div class="order-summary">
            <h2>Order Summary</h2>
            <div class="plan-details">
                <h3>{{ plan_name }}</h3>
                <p class="plan-price">${{ plan_price }}</p>
                <ul class="plan-features">
                    {% if plan_name == 'Basic Plan' %}
                        <li>1 Lease Analysis</li>
                        <li>Risk Analysis Report</li>
                        <li>PDF Export</li>
                    {% elif plan_name == 'Standard Plan' %}
                        <li>3 Lease Analyses</li>
                        <li>Valid for 30 days</li>
                        <li>Priority Support</li>
                    {% else %}
                        <li>6 Lease Analyses</li>
                        <li>Valid for 30 days</li>
                        <li>Priority Support + Consultation</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <div class="payment-form">
            <form id="payment-form">
                <div class="form-group">
                    <div id="card-element"></div>
                    <div id="card-errors" role="alert"></div>
                </div>
                <button type="submit" class="pay-button">Pay Now</button>
            </form>
        </div>
    </main>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        const {paymentMethod, error} = await stripe.createPaymentMethod({
            type: 'card',
            card: card,
        });

        if (error) {
            const errorElement = document.getElementById('card-errors');
            errorElement.textContent = error.message;
        } else {
            fetch('/create-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    payment_method_id: paymentMethod.id,
                    plan_id: '{{ plan_id }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.requires_action) {
                    stripe.confirmCardPayment(data.client_secret).then(function(result) {
                        if (result.error) {
                            const errorElement = document.getElementById('card-errors');
                            errorElement.textContent = result.error.message;
                        } else {
                            window.location.href = '/payment-status?status=success';
                        }
                    });
                } else if (data.success) {
                    window.location.href = '/payment-status?status=success';
                } else {
                    window.location.href = '/payment-status?status=failed';
                }
            });
        }
    });
</script>
{% endblock %}
