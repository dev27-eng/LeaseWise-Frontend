{% extends "base.html" %}

{% block title %}Checkout - LeaseCheck{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/checkout.css') }}">
{% endblock %}

{% block content %}
<div class="checkout-screen">
    <header class="green-header">
        <h1>Checkout</h1>
    </header>

    <main class="checkout-content">
        <!-- Test Mode Notice -->
        <div class="test-mode-notice">
            <h4>ðŸ”” Test Mode Enabled</h4>
            <p>Use these test cards to simulate different payment scenarios:</p>
            <ul>
                <li><strong>Success:</strong> 4242 4242 4242 4242</li>
                <li><strong>3D Secure:</strong> 4000 0025 0000 3155</li>
                <li><strong>Decline:</strong> 4000 0000 0000 9995</li>
                <li><strong>Exp Date:</strong> Any future date</li>
                <li><strong>CVV:</strong> Any 3 digits</li>
            </ul>
        </div>

        <div class="order-summary">
            <h2>Order Summary</h2>
            <div class="plan-details">
                <h3>{{ plan_name }}</h3>
                <p class="plan-price">${{ plan_price }}</p>
                <ul class="plan-features">
                    {% if plan_name == 'Basic Plan' %}
                        <li>1 Lease Analysis</li>
                        <li>Risk Analysis Report</li>
                        <li>PDF Export</li>
                    {% elif plan_name == 'Standard Plan' %}
                        <li>3 Lease Analyses</li>
                        <li>Valid for 30 days</li>
                        <li>Priority Support</li>
                    {% else %}
                        <li>6 Lease Analyses</li>
                        <li>Valid for 30 days</li>
                        <li>Priority Support + Consultation</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <div class="payment-form">
            <form id="payment-form">
                <!-- User Information Section -->
                <div class="form-section">
                    <h3>User Information</h3>
                    <div class="form-group">
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" name="fullName" required>
                        <div class="error-message" id="fullName-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address *</label>
                        <input type="email" id="email" name="email" required>
                        <div class="error-message" id="email-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" required>
                        <div class="error-message" id="phone-error"></div>
                    </div>
                </div>

                <!-- Billing Address Section -->
                <div class="form-section">
                    <h3>Billing Address</h3>
                    <div class="form-group">
                        <label for="street">Street Address *</label>
                        <input type="text" id="street" name="street" required>
                        <div class="error-message" id="street-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="street2">Apartment, suite, etc. (optional)</label>
                        <input type="text" id="street2" name="street2">
                        <div class="error-message" id="street2-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="city">City *</label>
                        <input type="text" id="city" name="city" required>
                        <div class="error-message" id="city-error"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="state">State/Province *</label>
                            <input type="text" id="state" name="state" required>
                            <div class="error-message" id="state-error"></div>
                        </div>
                        <div class="form-group half">
                            <label for="zipCode">ZIP/Postal Code *</label>
                            <input type="text" id="zipCode" name="zipCode" required>
                            <div class="error-message" id="zipCode-error"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="country">Country *</label>
                        <select id="country" name="country" required>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="GB">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                            <option value="NL">Netherlands</option>
                            <option value="BE">Belgium</option>
                        </select>
                        <div class="error-message" id="country-error"></div>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="form-section">
                    <h3>Payment Details</h3>
                    <div class="form-group">
                        <div id="card-element"></div>
                        <div id="card-errors" role="alert"></div>
                    </div>
                </div>

                <button type="submit" class="pay-button">Pay Now</button>
            </form>
        </div>
    </main>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    // Initialize Stripe
    let stripe = Stripe('{{ stripe_public_key }}');
    let elements = stripe.elements();

    // Card element styling
    let cardElementOptions = {
        style: {
            base: {
                fontSize: '16px',
                color: '#32325d',
                fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                fontSmoothing: 'antialiased',
                '::placeholder': {
                    color: '#aab7c4'
                },
                ':-webkit-autofill': {
                    color: '#32325d'
                }
            },
            invalid: {
                color: '#fa755a',
                iconColor: '#fa755a',
                '::placeholder': {
                    color: '#FFCCA5'
                }
            }
        }
    };

    // Create and mount the card element
    let card = elements.create('card', cardElementOptions);
    card.mount('#card-element');

    // Handle card element errors
    card.addEventListener('change', function(event) {
        let displayError = document.getElementById('card-errors');
        if (event.error) {
            if (event.error.code === 'incomplete_cvc') {
                displayError.textContent = 'Please enter a valid CVC/CVV number.';
            } else if (event.error.code === 'invalid_cvc') {
                displayError.textContent = 'The CVC/CVV number is invalid.';
            } else {
                displayError.textContent = event.error.message;
            }
        } else {
            displayError.textContent = '';
        }
    });

    // Validation functions
    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function validatePhone(phone) {
        return /^\+?[\d\s-()]{10,}$/.test(phone);
    }

    function validateRequired(value, fieldName) {
        if (!value || value.trim() === '') {
            return `${fieldName} is required`;
        }
        return '';
    }

    function validateForm() {
        let isValid = true;
        let fields = {
            'fullName': 'Full Name',
            'email': 'Email Address',
            'phone': 'Phone Number',
            'street': 'Street Address',
            'city': 'City',
            'state': 'State/Province',
            'zipCode': 'ZIP/Postal Code',
            'country': 'Country'
        };

        for (let id in fields) {
            let element = document.getElementById(id);
            let errorElement = document.getElementById(`${id}-error`);
            let error = validateRequired(element.value, fields[id]);
            
            if (error) {
                errorElement.textContent = error;
                errorElement.style.display = 'block';
                isValid = false;
            } else {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }

        let emailElement = document.getElementById('email');
        let emailErrorElement = document.getElementById('email-error');
        if (!validateEmail(emailElement.value)) {
            emailErrorElement.textContent = 'Please enter a valid email address';
            emailErrorElement.style.display = 'block';
            isValid = false;
        }

        let phoneElement = document.getElementById('phone');
        let phoneErrorElement = document.getElementById('phone-error');
        if (!validatePhone(phoneElement.value)) {
            phoneErrorElement.textContent = 'Please enter a valid phone number';
            phoneErrorElement.style.display = 'block';
            isValid = false;
        }

        return isValid;
    }

    // Form submission handler
    document.getElementById('payment-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        if (!validateForm()) {
            return;
        }

        let submitButton = document.querySelector('.pay-button');
        submitButton.disabled = true;

        try {
            let { paymentMethod, error: paymentMethodError } = await stripe.createPaymentMethod({
                type: 'card',
                card: card,
                billing_details: {
                    name: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: {
                        line1: document.getElementById('street').value,
                        line2: document.getElementById('street2').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        postal_code: document.getElementById('zipCode').value,
                        country: document.getElementById('country').value
                    }
                }
            });

            if (paymentMethodError) {
                let errorElement = document.getElementById('card-errors');
                if (paymentMethodError.code === 'incomplete_cvc' || paymentMethodError.code === 'invalid_cvc') {
                    errorElement.textContent = 'Please enter a valid CVC/CVV number.';
                } else {
                    errorElement.textContent = paymentMethodError.message;
                }
                submitButton.disabled = false;
                return;
            }

            let formData = {
                payment_method_id: paymentMethod.id,
                plan_id: '{{ plan_id }}',
                user_info: {
                    full_name: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: {
                        street: document.getElementById('street').value,
                        street2: document.getElementById('street2').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        zip_code: document.getElementById('zipCode').value,
                        country: document.getElementById('country').value
                    }
                }
            };

            let response = await fetch('/create-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            let data = await response.json();

            if (data.requires_action) {
                let { error: confirmError } = await stripe.confirmCardPayment(data.client_secret);
                if (confirmError) {
                    let errorElement = document.getElementById('card-errors');
                    if (confirmError.code === 'incomplete_cvc' || confirmError.code === 'invalid_cvc') {
                        errorElement.textContent = 'Please enter a valid CVC/CVV number.';
                    } else {
                        errorElement.textContent = confirmError.message;
                    }
                    submitButton.disabled = false;
                } else {
                    window.location.href = '/payment-status?status=success';
                }
            } else if (data.success) {
                window.location.href = '/payment-status?status=success';
            } else {
                window.location.href = '/payment-status?status=failed';
            }
        } catch (error) {
            let errorElement = document.getElementById('card-errors');
            errorElement.textContent = 'An error occurred processing your payment. Please try again.';
            submitButton.disabled = false;
        }
    });
</script>
{% endblock %}
