{% extends "base.html" %}

{% block title %}Processing Status - LeaseCheck{% endblock %}

{% block extra_css %}
<style>
    .processing-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
    }

    .status-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .progress-container {
        margin: 20px 0;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background-color: #7ED321;
        transition: width 0.3s ease;
        width: 0%;
    }

    .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 10px;
    }

    .status-pending {
        background-color: #ffd700;
        color: #856404;
    }

    .status-processing {
        background-color: #17a2b8;
        color: white;
    }

    .status-completed {
        background-color: #7ED321;
        color: white;
    }

    .status-error {
        background-color: #dc3545;
        color: white;
    }

    .processing-steps {
        margin-top: 20px;
    }

    .step-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
    }

    .step-icon {
        margin-right: 15px;
        font-size: 20px;
    }

    .step-pending {
        color: #6c757d;
    }

    .step-current {
        color: #17a2b8;
    }

    .step-completed {
        color: #7ED321;
    }

    .step-error {
        color: #dc3545;
    }

    .error-message {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
    }

    .action-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }

    .action-button {
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        cursor: pointer;
        border: none;
        font-size: 14px;
    }

    .primary-button {
        background-color: #7ED321;
        color: black;
    }

    .secondary-button {
        background-color: #6c757d;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="processing-container">
    <header>
        <h1>Document Processing Status</h1>
    </header>

    <div class="status-card">
        <div class="status-badge status-{{ document.status }}">
            {{ document.status|title }}
        </div>
        
        <h2>{{ document.original_filename }}</h2>
        
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <p id="progressText">0% Complete</p>
        </div>

        <div class="processing-steps">
            <div class="step-item" id="uploadStep">
                <span class="step-icon">üì§</span>
                <span>Document Upload</span>
            </div>
            <div class="step-item" id="validationStep">
                <span class="step-icon">‚úì</span>
                <span>Document Validation</span>
            </div>
            <div class="step-item" id="analysisStep">
                <span class="step-icon">üîç</span>
                <span>Content Analysis</span>
            </div>
            <div class="step-item" id="completionStep">
                <span class="step-icon">üéâ</span>
                <span>Processing Complete</span>
            </div>
        </div>

        {% if document.error_message %}
        <div class="error-message">
            {{ document.error_message }}
        </div>
        {% endif %}

        <div class="action-buttons">
            {% if document.status == 'processed' %}
            <a href="{{ url_for('view_document', document_id=document.id) }}" class="action-button primary-button">
                View Results
            </a>
            {% endif %}
            <a href="{{ url_for('lease_upload') }}" class="action-button secondary-button">
                Upload Another Document
            </a>
        </div>
    </div>
</div>

<script>
    const documentId = '{{ document.id }}';
    let processingComplete = false;

    function updateProgress(status, progress) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const uploadStep = document.getElementById('uploadStep');
        const validationStep = document.getElementById('validationStep');
        const analysisStep = document.getElementById('analysisStep');
        const completionStep = document.getElementById('completionStep');

        // Update progress bar
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${progress}% Complete`;

        // Update steps based on status
        const steps = {
            'pending': 0,
            'validating': 25,
            'analyzing': 50,
            'processing': 75,
            'processed': 100,
            'error': null
        };

        // Reset all steps
        [uploadStep, validationStep, analysisStep, completionStep].forEach(step => {
            step.classList.remove('step-completed', 'step-current', 'step-error');
            step.classList.add('step-pending');
        });

        if (status === 'error') {
            // Handle error state
            uploadStep.classList.add('step-error');
        } else {
            // Update steps based on progress
            if (progress >= 25) uploadStep.classList.add('step-completed');
            if (progress >= 50) validationStep.classList.add('step-completed');
            if (progress >= 75) analysisStep.classList.add('step-completed');
            if (progress === 100) {
                completionStep.classList.add('step-completed');
                processingComplete = true;
            }

            // Show current step
            if (progress < 25) uploadStep.classList.add('step-current');
            else if (progress < 50) validationStep.classList.add('step-current');
            else if (progress < 75) analysisStep.classList.add('step-current');
            else if (progress < 100) completionStep.classList.add('step-current');
        }
    }

    function checkProgress() {
        if (processingComplete) return;

        fetch(`/api/document-status/${documentId}`)
            .then(response => response.json())
            .then(data => {
                updateProgress(data.status, data.progress);
                if (!processingComplete) {
                    setTimeout(checkProgress, 2000);
                }
            })
            .catch(error => {
                console.error('Error checking progress:', error);
                setTimeout(checkProgress, 5000);
            });
    }

    // Start progress checking when page loads
    document.addEventListener('DOMContentLoaded', checkProgress);
</script>
{% endblock %}
