{% extends "base.html" %}

{% block title %}Processing Status - LeaseCheck{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/progress-tracker.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/error-display.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/support-ticket.css') }}">
{% endblock %}

{% from 'components/progress-tracker.html' import progress_tracker %}
{% from 'components/support-ticket.html' import support_ticket_modal %}

{% block content %}
<div class="processing-container">
    <header>
        <h1>Document Processing Status</h1>
    </header>

    <div class="status-card">
        <div class="status-badge status-{{ document.status }}">
            {{ document.status|title }}
        </div>
        
        <h2>{{ document.original_filename }}</h2>
        
        {{ progress_tracker() }}

        {% if document.error_message %}
        <div class="error-message">
            {{ document.error_message }}
        </div>
        {% endif %}

        <div class="action-buttons">
            {% if document.status == 'processed' %}
            <a href="{{ url_for('view_document', document_id=document.id) }}" class="action-button primary-button">
                View Results
            </a>
            {% endif %}
            <a href="{{ url_for('lease_upload') }}" class="action-button secondary-button">
                Upload Another Document
            </a>
        </div>
    </div>
</div>

{{ support_ticket_modal() }}

<script src="{{ url_for('static', filename='js/progress-tracker.js') }}"></script>
<script src="{{ url_for('static', filename='js/support-ticket.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const progressTracker = new ProgressTracker('progressContainer');
    const supportTicket = new SupportTicket();
    let processingComplete = false;

    function checkProgress() {
        if (processingComplete) return;

        fetch(`/api/document-status/{{ document.id }}`)
            .then(response => response.json())
            .then(data => {
                progressTracker.updateProgress(data.status, data.progress);
                if (!processingComplete && data.progress < 100) {
                    setTimeout(checkProgress, 2000);
                }
            })
            .catch(error => {
                console.error('Error checking progress:', error);
                setTimeout(checkProgress, 5000);
            });
    }

    checkProgress();
});
</script>
{% endblock %}